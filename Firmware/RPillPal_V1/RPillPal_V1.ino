#include <Wire.h>
#include <OneButton.h>
#include <Adafruit_GFX.h>
#include <Adafruit_SSD1306.h>
#include <Stepper.h>

#define SCREEN_WIDTH 128
#define SCREEN_HEIGHT 32

Adafruit_SSD1306 display(SCREEN_WIDTH, SCREEN_HEIGHT, &Wire, -1);

const unsigned char epd_bitmap_ANAVEO_128x32 [] PROGMEM = {
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
	0xff, 0xfd, 0xff, 0xe7, 0xff, 0x1f, 0xff, 0x7e, 0x3f, 0xff, 0x8c, 0x00, 0x1f, 0xf0, 0x07, 0xff, 
	0xff, 0xf8, 0xff, 0xe3, 0xff, 0x1f, 0xfe, 0x3e, 0x3f, 0xff, 0x1c, 0x00, 0x1f, 0xc0, 0x00, 0xff, 
	0xff, 0xf0, 0x7f, 0xe1, 0xff, 0x1f, 0xfc, 0x1f, 0x1f, 0xfe, 0x3c, 0x00, 0x1f, 0x80, 0x00, 0x7f, 
	0xff, 0xf0, 0x3f, 0xe0, 0xff, 0x1f, 0xfc, 0x0f, 0x8f, 0xfe, 0x3c, 0xff, 0xff, 0x1f, 0xfc, 0x3f, 
	0xff, 0xe2, 0x3f, 0xe0, 0x7f, 0x1f, 0xf8, 0x8f, 0x8f, 0xfc, 0x7c, 0xff, 0xfe, 0x3f, 0xfe, 0x3f, 
	0xff, 0xe3, 0x1f, 0xe4, 0x3f, 0x1f, 0xf8, 0xc7, 0xc7, 0xfc, 0x7c, 0xff, 0xfe, 0x3f, 0xff, 0x1f, 
	0xff, 0xc7, 0x1f, 0xe6, 0x1f, 0x1f, 0xf1, 0xc7, 0xc7, 0xf8, 0xfc, 0xff, 0xfe, 0x7f, 0xff, 0x1f, 
	0xff, 0x8f, 0x8f, 0xe7, 0x0f, 0x1f, 0xe3, 0xe3, 0xe3, 0xf1, 0xfc, 0xc0, 0x1e, 0x7f, 0xff, 0x9f, 
	0xff, 0x8f, 0x87, 0xe7, 0x87, 0x1f, 0xe3, 0xe1, 0xf1, 0xf1, 0xfc, 0xc0, 0x1c, 0x7f, 0xff, 0x9f, 
	0xff, 0x18, 0x07, 0xe7, 0xc3, 0x1f, 0xc6, 0x01, 0xf1, 0xe3, 0xfc, 0xc0, 0x1e, 0x7f, 0xff, 0x9f, 
	0xff, 0x18, 0x03, 0xe7, 0xe1, 0x1f, 0xc6, 0x00, 0xf8, 0xe3, 0xfc, 0xff, 0xfe, 0x7f, 0xff, 0x1f, 
	0xfe, 0x30, 0x03, 0xe7, 0xf0, 0x1f, 0x8c, 0x00, 0xf8, 0xc7, 0xfc, 0xff, 0xfe, 0x7f, 0xff, 0x3f, 
	0xfc, 0x3f, 0xf1, 0xe7, 0xf8, 0x1f, 0x0f, 0xfc, 0x7c, 0x0f, 0xfc, 0xff, 0xfe, 0x3f, 0xfe, 0x3f, 
	0xfc, 0x7f, 0xf1, 0xe7, 0xfc, 0x1f, 0x1f, 0xfc, 0x7e, 0x0f, 0xfc, 0xff, 0xff, 0x1f, 0xfc, 0x7f, 
	0xf8, 0xff, 0xf8, 0xe7, 0xfe, 0x1e, 0x3f, 0xfe, 0x3e, 0x1f, 0xfc, 0x00, 0x1f, 0x80, 0x00, 0x7f, 
	0xf8, 0xff, 0xf8, 0xe7, 0xff, 0x1e, 0x3f, 0xfe, 0x3f, 0x1f, 0xfc, 0x00, 0x1f, 0xc0, 0x01, 0xff, 
	0xf1, 0xff, 0xfc, 0x67, 0xff, 0xbc, 0x7f, 0xff, 0x1f, 0xbf, 0xfc, 0x00, 0x1f, 0xf0, 0x07, 0xff, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff
};
 
#define KEY1 13
#define KEY2 12
#define KEY3 11
#define KEYPOUND 9

#define BUZZER 10


const uint16_t stepsPerRevolution = 2038;
Stepper myStepper = Stepper(stepsPerRevolution, 4, 6, 5, 7);

OneButton K1 = OneButton(
  KEY1,
  true,
  true
);
OneButton K2 = OneButton(
  KEY2,
  true,
  true
);
OneButton K3 = OneButton(
  KEY3,
  true,
  true
);
OneButton KP = OneButton(
  KEYPOUND,
  true,
  true
);

uint8_t CORR_ID[3] = {1, 2, 3};
uint8_t ID[3];
uint8_t count = 0;

uint16_t pillCount = 120;

void dispensePill(uint8_t amount) {
  myStepper.setSpeed(5);
  for (int i = 0; i < amount; i++) {
    Serial.println("Yeet");
	  myStepper.step(stepsPerRevolution);
    delay(1000);
  }
}

static void numKeyPress(uint8_t num) {
  ID[count] = num;
  count += 1;
  tone(BUZZER, 1000, 200);
  if (count == 3) {
    keyPoundPress();
  }
}

static void key1Press() {numKeyPress(1);}
static void key2Press() {numKeyPress(2);}
static void key3Press() {numKeyPress(3);}

static void keyPoundPress() {
  count = 0;
  bool wrongFlag = false;
  for (int i = 0; i < 3; i++) {
    if (ID[i] != CORR_ID[i]) {
      wrongFlag = true;
    }
    Serial.print(ID[i]);
  }
  if (wrongFlag) {
    tone(BUZZER, 900, 200);
    Serial.println("Incorrect Password");
  }
  else {
    tone(BUZZER, 1500, 200);
    Serial.println("Correct Password");
    dispensePill(3);
  }
  Serial.println("");
}

void displayData() {
  display.clearDisplay();

  display.setTextSize(1);
  int batteryBars = random(0, 5);

  display.drawRoundRect(34, 0, 94, 32, 4, 1);
  int startX = 37;
  for (int i = 0; i < batteryBars; i++) {
    display.fillRoundRect(startX, 2, 7, 28, 2, 1);
    startX += 9;
  }
  
  display.setTextColor(WHITE);
  display.setCursor(40, 0);
  display.print(F("TRB: ")); 
  display.setCursor(85, 0);
  display.setCursor(40, 18); 
  display.print(F("OUT: "));     
  display.setCursor(85, 18);
  display.print("5V"); 
  
  display.display();
}

void setup() {
  // put your setup code here, to run once:
  Serial.begin(9600);
  if(!display.begin(SSD1306_SWITCHCAPVCC, 0x3C)) {
    Serial.println(F("SSD1306 allocation failed"));
    for(;;);
  }
  delay(2000); // Pause for 2 seconds
 
  // Clear the buffer.
  display.clearDisplay();
  display.setFont();
  display.setTextSize(1);

  // // Draw bitmap on the screen
  // display.drawBitmap(0, 5, epd_bitmap_ANAVEO_128x32, 128, 32, WHITE);
  // display.display();
  // // delay(4000);
  
  K1.attachClick(key1Press);
  K2.attachClick(key2Press);
  K3.attachClick(key3Press);
  KP.attachClick(keyPoundPress);

  pinMode(BUZZER, OUTPUT);
  displayData();
}

void loop() {
  K1.tick();
  K2.tick();
  K3.tick();
  KP.tick();
}
